package handlers

import (
	"AiHackathon-admin/internal/models"
	"database/sql"
	"encoding/json"
	"fmt"
	"html/template"
	"log"
	"net/http"
	"path/filepath"
	"sort"
	"strings"
	"time"
)

// DBStore ‰ªãÈù¢Êõ¥Êñ∞ÔºöGetAllVideosWithAnalysis ÁèæÂú®Êé•Êî∂ÁØ©ÈÅ∏ÂíåÊéíÂ∫èÂèÉÊï∏
type DBStore interface {
	GetAllVideosWithAnalysis(limit int, offset int, searchTerm string, sortBy string, sortOrder string) ([]models.Video, []models.AnalysisResult, error)
	Close() error
	FindOrCreateVideo(video *models.Video) (int64, error)
	SaveAnalysisResult(result *models.AnalysisResult) error
	UpdateVideoAnalysisStatus(videoID int64, status models.AnalysisStatus, analyzedAt sql.NullTime, errorMessage sql.NullString) error
	GetPendingVideos(limit int) ([]models.Video, error)
	GetVideoByID(videoID int64) (*models.Video, error)
	GetVideosPendingContentAnalysis(status models.AnalysisStatus, limit int) ([]models.Video, error)
}

// DashboardPageData Êõ¥Êñ∞ÔºöÂä†ÂÖ•ÁØ©ÈÅ∏ÂíåÊéíÂ∫èÁöÑÁï∂ÂâçÂÄºÔºå‰ª•‰æøÂú®ÁØÑÊú¨‰∏≠Ë®≠ÂÆöË°®ÂñÆÈ†êË®≠ÂÄº
type DashboardPageData struct {
	Videos     []VideoDisplayData
	SearchTerm string
	SortBy     string
	SortOrder  string
	Paging     PagingData // ÂèØÈÅ∏ÔºöÁî®ÊñºÂ∞á‰æÜÂØ¶ÁèæÂàÜÈ†Å
}

// PagingData (ÂèØÈÅ∏ÔºåÁÇ∫Â∞á‰æÜÂàÜÈ†ÅÂÅöÊ∫ñÂÇô)
type PagingData struct {
	CurrentPage int
	TotalPages  int
	HasPrev     bool
	HasNext     bool
	PrevPage    int
	NextPage    int
}

// VideoDisplayData Êõ¥Êñ∞ÔºöÂä†ÂÖ• CombinedSourceID
type VideoDisplayData struct {
	VideoID                  int64
	SourceName               string // ‰øùÁïôÂéüÂßã SourceName
	SourceID                 string // ‰øùÁïôÂéüÂßã SourceID
	CombinedSourceID         string // *** Êñ∞Â¢ûÔºöÁî®ÊñºÈ°ØÁ§∫ SourceName(Â§ßÂØ´) + SourceID ***
	NASPath                  string
	Title                    string
	AnalysisStatus           models.AnalysisStatus
	AnalysisResult           *DisplayableAnalysisResult
	PublishedAt              sql.NullTime
	FetchedAt                time.Time
	DurationSecs             sql.NullInt64
	FormattedDurationMinutes int64
	FormattedDurationSeconds int64
	ShotlistContent          models.JsonNullString
	ViewLink                 sql.NullString
	PrimaryLocation          string
	PrimarySubjects          []string
	FlagEmoji                string
	VideoURL                 string
}

// KeywordDisplay, BiteDisplay, ImportanceScoreDisplay, DisplayableAnalysisResult (‰øùÊåÅ‰∏çËÆä)
type KeywordDisplay struct {
	Keyword  string `json:"keyword"`
	Category string `json:"category"`
}
type BiteDisplay struct {
	Speaker string `json:"speaker"`
	Quote   string `json:"quote"`
}
type ImportanceScoreDisplay struct {
	OverallRating     string   `json:"overall_rating"`
	KeyFactors        []string `json:"key_factors"`
	AssessmentDetails string   `json:"assessment_details"`
}
type DisplayableAnalysisResult struct {
	Transcript              *models.JsonNullString
	Translation             *models.JsonNullString
	ShortSummary            *models.JsonNullString
	BulletedSummary         *models.JsonNullString
	VisualDescription       *models.JsonNullString
	MaterialType            *models.JsonNullString
	ConsolidatedCategories  []string
	VideoMentionedLocations []string
	Keywords                []KeywordDisplay
	Bites                   []BiteDisplay
	ImportanceScore         *ImportanceScoreDisplay
	RelatedNews             []string
	ErrorMessage            *models.JsonNullString
	PromptVersion           string
	AnalysisCreatedAt       time.Time
}

// DashboardHandler (‰øùÊåÅ‰∏çËÆä)
type DashboardHandler struct {
	db       DBStore
	tpl      *template.Template
	basePath string
}

// NewDashboardHandler (‰øùÊåÅ‰∏çËÆä)
func NewDashboardHandler(db DBStore, templateBasePath string) (*DashboardHandler, error) {
	if db == nil {
		return nil, fmt.Errorf("DBStore‰∏çÂæóÁÇ∫nil")
	}
	tplPath := filepath.Join(templateBasePath, "dashboard.html")
	tpl, err := template.ParseFiles(tplPath)
	if err != nil {
		return nil, fmt.Errorf("ÁÑ°Ê≥ïËß£ÊûêÂÑÄË°®ÊùøÁØÑÊú¨ '%s': %w", tplPath, err)
	}
	return &DashboardHandler{db: db, tpl: tpl, basePath: templateBasePath}, nil
}
func getFlagForLocationGo(locationString string) string { /* ... */
	if locationString == "" {
		return ""
	}
	locationLower := strings.ToLower(locationString)
	if strings.Contains(locationLower, "ÁæéÂúã") || strings.Contains(locationLower, "u.s.") || strings.Contains(locationLower, "usa") || strings.Contains(locationLower, "ËèØÁõõÈ†ì") {
		return "üá∫üá∏"
	}
	if strings.Contains(locationLower, "Êó•Êú¨") || strings.Contains(locationLower, "japan") || strings.Contains(locationLower, "Êù±‰∫¨") {
		return "üáØüáµ"
	}
	if strings.Contains(locationLower, "‰∏≠Âúã") || strings.Contains(locationLower, "china") || strings.Contains(locationLower, "Âåó‰∫¨") || strings.Contains(locationLower, "‰∏äÊµ∑") || strings.Contains(locationLower, "Â±±Êù±") {
		return "üá®üá≥"
	}
	if strings.Contains(locationLower, "Âè∞ÁÅ£") || strings.Contains(locationLower, "taiwan") || strings.Contains(locationLower, "Ëá∫Âåó") || strings.Contains(locationLower, "Âè∞Âåó") {
		return "üáπüáº"
	}
	if strings.Contains(locationLower, "ÂçóÈùû") || strings.Contains(locationLower, "south africa") || strings.Contains(locationLower, "Á¥ÑÁø∞Â∞ºÊñØÂ†°") {
		return "üáøüá¶"
	}
	if strings.Contains(locationLower, "Ê≥ïÂúã") || strings.Contains(locationLower, "france") || strings.Contains(locationLower, "Â∑¥Èªé") {
		return "üá´üá∑"
	}
	if strings.Contains(locationLower, "Ëã±Âúã") || strings.Contains(locationLower, "u.k.") || strings.Contains(locationLower, "britain") {
		return "üá¨üáß"
	}
	if strings.Contains(locationLower, "‰ª•Ëâ≤Âàó") || strings.Contains(locationLower, "israel") {
		return "üáÆüá±"
	}
	if strings.Contains(locationLower, "Âä†Ëñ©") || strings.Contains(locationLower, "gaza") {
		return "üáµüá∏"
	}
	return "üè≥Ô∏è"
}
func getRatingWeight(rating string) int {
	upperRating := strings.ToUpper(rating)
	switch upperRating {
	case "S":
		return 5
	case "A":
		return 4
	case "B":
		return 3
	case "C":
		return 2
	case "N":
		return 1
	default:
		return 0
	}
}

// ServeHTTP ÊñπÊ≥ïÊõ¥Êñ∞ÔºöËÆÄÂèñÊü•Ë©¢ÂèÉÊï∏ÔºåÂÇ≥ÈÅûÁµ¶Ë≥áÊñôÂ∫´Â±§Ôºå‰∏¶Ë™øÊï¥ÊéíÂ∫èÈÇèËºØ
func (h *DashboardHandler) ServeHTTP(w http.ResponseWriter, r *http.Request) {
	log.Printf("Ë≥áË®äÔºöÊî∂Âà∞ %s %s Ë´ãÊ±Ç\n", r.Method, r.URL.Path)

	// Âæû URL Êü•Ë©¢ÂèÉÊï∏ËÆÄÂèñÁØ©ÈÅ∏ÂíåÊéíÂ∫èÊ¢ù‰ª∂
	searchTerm := r.URL.Query().Get("search")
	sortBy := r.URL.Query().Get("sortBy")
	sortOrder := r.URL.Query().Get("sortOrder")

	// Ë®≠ÂÆöÈ†êË®≠ÊéíÂ∫èÔºàÂ¶ÇÊûúÂâçÁ´ØÊú™Êèê‰æõÔºâ
	if sortBy == "" {
		sortBy = "importance" // È†êË®≠ÊåâË©ïÂàÜÊéíÂ∫è
	}
	if sortOrder == "" {
		sortOrder = "desc" // È†êË®≠ÈôçÂÜ™
	}

	// TODO: ÂØ¶ÁèæÂàÜÈ†ÅÈÇèËºØ (limit, offset)
	limit := 20 // Êö´ÊôÇÂõ∫ÂÆöÊØèÈ†ÅÊï∏Èáè
	offset := 0

	videos, analysisResults, err := h.db.GetAllVideosWithAnalysis(limit, offset, searchTerm, sortBy, sortOrder)
	if err != nil {
		log.Printf("ÈåØË™§ÔºöÂæûË≥áÊñôÂ∫´Áç≤ÂèñÂΩ±ÁâáÊï∏ÊìöÂ§±Êïó: %v", err)
		http.Error(w, "ÁÑ°Ê≥ïËºâÂÖ•ÂÑÄË°®ÊùøÊï∏Êìö", http.StatusInternalServerError)
		return
	}

	var displayData []VideoDisplayData
	analysisResultMap := make(map[int64]models.AnalysisResult)
	for _, ar := range analysisResults {
		analysisResultMap[ar.VideoID] = ar
	}

	for _, v := range videos {
		displayItem := VideoDisplayData{
			VideoID:    v.ID,
			SourceName: v.SourceName, // ‰øùÁïôÂéüÂßã SourceName
			SourceID:   v.SourceID,   // ‰øùÁïôÂéüÂßã SourceID
			// *** Â°´ÂÖÖ CombinedSourceID ***
			CombinedSourceID: fmt.Sprintf("%s%s", strings.ToUpper(v.SourceName), v.SourceID),
			NASPath:          v.NASPath, Title: v.Title.String, AnalysisStatus: v.AnalysisStatus,
			AnalysisResult: nil, PublishedAt: v.PublishedAt, FetchedAt: v.FetchedAt,
			DurationSecs: v.DurationSecs, ShotlistContent: v.ShotlistContent, ViewLink: v.ViewLink,
			PrimaryLocation: v.Location.String, FlagEmoji: getFlagForLocationGo(v.Location.String),
			VideoURL: fmt.Sprintf("/media/%s", v.NASPath),
		}
		if v.DurationSecs.Valid {
			displayItem.FormattedDurationMinutes = v.DurationSecs.Int64 / 60
			displayItem.FormattedDurationSeconds = v.DurationSecs.Int64 % 60
		}
		if len(v.Subjects) > 0 && string(v.Subjects) != "null" {
			var txtSubjects []string
			if errJ := json.Unmarshal(v.Subjects, &txtSubjects); errJ == nil {
				displayItem.PrimarySubjects = txtSubjects
			} else {
				log.Printf("Ë≠¶ÂëäÔºö[DashboardHandler] ÁÑ°Ê≥ïÂ∞á Video.Subjects (ID: %d) JSON ('%s') Ëß£ÊûêÁÇ∫ []string: %v„ÄÇ", v.ID, string(v.Subjects), errJ)
			}
		}

		if ar, ok := analysisResultMap[v.ID]; ok {
			displayableAR := &DisplayableAnalysisResult{
				PromptVersion: ar.PromptVersion, Transcript: ar.Transcript, Translation: ar.Translation,
				ShortSummary: ar.ShortSummary, BulletedSummary: ar.BulletedSummary,
				VisualDescription: ar.VisualDescription, MaterialType: ar.MaterialType, ErrorMessage: ar.ErrorMessage,
				AnalysisCreatedAt: ar.CreatedAt,
			}
			var consolidatedCategoriesMap = make(map[string]bool)
			var consolidatedCategories []string
			for _, subj := range displayItem.PrimarySubjects {
				trimmedSubj := strings.TrimSpace(subj)
				if trimmedSubj != "" && !strings.HasPrefix(trimmedSubj, "ÂéüÂßãÊï∏Êìö(Ëß£ÊûêÂ§±Êïó):") && !consolidatedCategoriesMap[trimmedSubj] {
					consolidatedCategoriesMap[trimmedSubj] = true
					consolidatedCategories = append(consolidatedCategories, trimmedSubj)
				}
			}
			if len(ar.Topics) > 0 && string(ar.Topics) != "null" {
				var geminiTopics []string
				if errJ := json.Unmarshal(ar.Topics, &geminiTopics); errJ == nil {
					for _, topic := range geminiTopics {
						trimmedTopic := strings.TrimSpace(topic)
						if trimmedTopic != "" && !consolidatedCategoriesMap[trimmedTopic] {
							consolidatedCategoriesMap[trimmedTopic] = true
							consolidatedCategories = append(consolidatedCategories, trimmedTopic)
						}
					}
				} else {
					log.Printf("Ë≠¶ÂëäÔºö[DashboardHandler] ÁÑ°Ê≥ïÂ∞á AnalysisResult.Topics (VideoID: %d) JSON ('%s') Ëß£ÊûêÁÇ∫ []string: %v„ÄÇ", ar.VideoID, string(ar.Topics), errJ)
					consolidatedCategories = append(consolidatedCategories, fmt.Sprintf("ÂéüÂßãTopics(Ëß£ÊûêÂ§±Êïó): %s", string(ar.Topics)))
				}
			}
			sort.Strings(consolidatedCategories)
			displayableAR.ConsolidatedCategories = consolidatedCategories

			parseAndSet := func(raw json.RawMessage, target interface{}, fieldName string) {
				if len(raw) > 0 && string(raw) != "null" {
					if errJ := json.Unmarshal(raw, target); errJ != nil {
						log.Printf("Ë≠¶ÂëäÔºö[DashboardHandler] ÁÑ°Ê≥ïÂ∞á %s (VideoID: %d) JSON ('%s') Ëß£Êûê: %v", fieldName, ar.VideoID, string(raw), errJ)
					}
				}
			}
			parseAndSet(ar.MentionedLocations, &displayableAR.VideoMentionedLocations, "MentionedLocations")
			parseAndSet(ar.Keywords, &displayableAR.Keywords, "Keywords")
			parseAndSet(ar.Bites, &displayableAR.Bites, "Bites")
			parseAndSet(ar.ImportanceScore, &displayableAR.ImportanceScore, "ImportanceScore")
			parseAndSet(ar.RelatedNews, &displayableAR.RelatedNews, "RelatedNews")

			displayItem.AnalysisResult = displayableAR
		}
		displayData = append(displayData, displayItem)
	}

	// --- ‰øÆÊîπÔºöÂè™ÊúâÂú® sortBy ÊòØ "importance" ÊôÇÊâçÂú® Go ‰∏≠ÊéíÂ∫è ---
	// ÂÖ∂‰ªñÊéíÂ∫èÔºàpublished_at, source_idÔºâÂ∞á‰æùË≥¥Ë≥áÊñôÂ∫´Â±§ÁöÑ ORDER BY
	if sortBy == "importance" {
		sort.Slice(displayData, func(i, j int) bool {
			var ratingI, ratingJ int
			var timeI, timeJ time.Time // Áî®ÊñºË©ïÂàÜÁõ∏ÂêåÊôÇÁöÑÊ¨°Ë¶ÅÊéíÂ∫è

			if displayData[i].AnalysisResult != nil && displayData[i].AnalysisResult.ImportanceScore != nil {
				ratingI = getRatingWeight(displayData[i].AnalysisResult.ImportanceScore.OverallRating)
			} else {
				ratingI = -1
			} // Êú™Ë©ïÂàÜÊàñÁÑ°ÂàÜÊûêÁµêÊûúÁöÑÊéíÂú®ÂæåÈù¢

			if displayData[j].AnalysisResult != nil && displayData[j].AnalysisResult.ImportanceScore != nil {
				ratingJ = getRatingWeight(displayData[j].AnalysisResult.ImportanceScore.OverallRating)
			} else {
				ratingJ = -1
			}

			// Ê†πÊìö sortOrder Ê±∫ÂÆöÂçáÂÜ™ÈÇÑÊòØÈôçÂÜ™
			if ratingI != ratingJ {
				if sortOrder == "asc" {
					return ratingI < ratingJ
				}
				return ratingI > ratingJ // È†êË®≠ÈôçÂÜ™
			}

			// Ë©ïÂàÜÁõ∏ÂêåÔºå‰ΩøÁî®ÁôºÂ∏ÉÊôÇÈñì‰ΩúÁÇ∫Ê¨°Ë¶ÅÊéíÂ∫è (ËºÉÊñ∞ÁöÑÂú®Ââç)
			if displayData[i].PublishedAt.Valid {
				timeI = displayData[i].PublishedAt.Time
			} else if !displayData[i].FetchedAt.IsZero() {
				timeI = displayData[i].FetchedAt
			} else if displayData[i].AnalysisResult != nil && !displayData[i].AnalysisResult.AnalysisCreatedAt.IsZero() {
				timeI = displayData[i].AnalysisResult.AnalysisCreatedAt
			} else {
				timeI = time.Time{}
			}

			if displayData[j].PublishedAt.Valid {
				timeJ = displayData[j].PublishedAt.Time
			} else if !displayData[j].FetchedAt.IsZero() {
				timeJ = displayData[j].FetchedAt
			} else if displayData[j].AnalysisResult != nil && !displayData[j].AnalysisResult.AnalysisCreatedAt.IsZero() {
				timeJ = displayData[j].AnalysisResult.AnalysisCreatedAt
			} else {
				timeJ = time.Time{}
			}

			if sortOrder == "asc" {
				return timeI.Before(timeJ)
			}
			return timeI.After(timeJ) // È†êË®≠ÈôçÂÜ™ (Êñ∞ÁöÑÂú®Ââç)
		})
	}
	// --- ÁµêÊùüÊéíÂ∫è‰øÆÊîπ ---

	pageData := DashboardPageData{
		Videos:     displayData,
		SearchTerm: searchTerm,
		SortBy:     sortBy,
		SortOrder:  sortOrder,
	}
	w.Header().Set("Content-Type", "text/html; charset=utf-8")
	if err := h.tpl.Execute(w, pageData); err != nil {
		log.Printf("ÈåØË™§ÔºöÂü∑Ë°åÂÑÄË°®ÊùøÁØÑÊú¨Â§±Êïó: %v", err)
	}
}
